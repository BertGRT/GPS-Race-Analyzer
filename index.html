<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=yes">
    <!-- PWA Support -->
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1976d2">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="GPS Analyzer">

    <script>
    if ('serviceWorker' in navigator) {
      navigator.serviceWorker.register('./sw.js')
        .then(reg => console.log('Service Worker enregistr√©'))
        .catch(err => console.log('Erreur SW:', err));
    }
    </script>
    <title>GPS Race Analyzer Pro</title>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.0/chart.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jszip/3.10.1/jszip.min.js"></script>
    
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .header {
            text-align: center;
            color: white;
            padding: 30px;
            margin-bottom: 30px;
            background: rgba(255,255,255,0.1);
            border-radius: 20px;
            backdrop-filter: blur(10px);
        }
        
        .header h1 { font-size: 2.5rem; margin-bottom: 10px; }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
        }
        
        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 40px;
            text-align: center;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            cursor: pointer;
            transition: all 0.3s ease;
            margin-bottom: 30px;
        }
        
        .upload-area:hover {
            border-color: #764ba2;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: translateY(-5px);
        }
        
        .upload-area.drag-over {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.02);
        }
        
        .upload-icon { font-size: 4rem; margin-bottom: 20px; }
        
        #session-content { display: none; }
        
        .session-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            flex-wrap: wrap;
            gap: 15px;
        }
        
        .session-info h2 { font-size: 1.8rem; color: #1976d2; margin-bottom: 5px; }
        .session-date { color: #666; }
        
        .session-badge {
            background: linear-gradient(45deg, #4CAF50, #8BC34A);
            color: white;
            padding: 8px 20px;
            border-radius: 20px;
            font-weight: bold;
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
            transition: transform 0.3s ease;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            margin-bottom: 8px;
        }

        .stat-label {
            font-size: 0.85rem;
            opacity: 0.9;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .tabs {
            display: flex;
            gap: 10px;
            margin-bottom: 25px;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
        }
        
        .tab {
            padding: 12px 25px;
            background: transparent;
            border: none;
            color: #666;
            font-weight: 500;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            transition: all 0.3s ease;
            font-size: 1rem;
        }
        
        .tab:hover { color: #1976d2; }
        
        .tab.active {
            color: #1976d2;
            border-bottom-color: #1976d2;
            font-weight: 600;
        }
        
        .tab-content {
            display: none;
            animation: fadeIn 0.4s ease;
        }
        
        .tab-content.active { display: block; }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }
        
        table thead {
            background: linear-gradient(45deg, #1976d2, #42a5f5);
            color: white;
        }
        
        table th, table td {
            padding: 12px 10px;
            text-align: center;
            border-bottom: 1px solid #e0e0e0;
        }
        
        table tbody tr:hover { background: #f8f9fa; }
        table tbody tr.best-lap { background: #e8f5e9 !important; font-weight: bold; }
        
        .delta-positive { color: #d32f2f; font-weight: bold; }
        .delta-zero { color: #2e7d32; font-weight: bold; }
        
        .map-controls {
            display: flex;
            gap: 10px;
            margin-bottom: 15px;
            flex-wrap: wrap;
        }
        
        .map-controls button {
            padding: 8px 15px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            font-weight: 500;
            transition: transform 0.2s ease;
        }
        
        .map-controls button:hover { transform: translateY(-2px); }
        
        .map-container {
            width: 100%;
            height: 500px;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            margin: 20px 0;
            position: relative;
        }
        
        #map {
            width: 100%;
            height: 100%;
            min-height: 500px;
            border-radius: 10px;
        }
        
        .track-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }
        
        .track-stat-card {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 8px;
            border-left: 4px solid #1976d2;
        }
        
        .track-stat-value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .track-stat-label {
            color: #666;
            font-size: 0.9rem;
        }
        
        .analysis-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .analysis-card {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #667eea;
        }
        
        .analysis-card h4 {
            color: #1976d2;
            margin-bottom: 15px;
        }
        
        .progress-bars { margin: 20px 0; }
        
        .progress-item {
            display: flex;
            align-items: center;
            margin: 12px 0;
        }
        
        .progress-label {
            width: 50px;
            font-weight: bold;
            color: #1976d2;
        }
        
        .progress-bar-container {
            flex: 1;
            height: 30px;
            background: #e0e0e0;
            border-radius: 15px;
            margin: 0 10px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-bar {
            height: 100%;
            border-radius: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 0.85rem;
            font-weight: bold;
            transition: width 0.5s ease;
        }
        
        .export-section {
            margin: 30px 0;
            padding: 20px;
            background: #f8f9fa;
            border-radius: 10px;
        }
        
        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }
        
        .export-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            color: white;
            transition: transform 0.2s ease;
        }
        
        .export-btn:hover { transform: translateY(-2px); }
        
        .replay-controls {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .replay-slider {
            width: 100%;
            margin: 15px 0;
        }
        
        .replay-buttons {
            display: flex;
            gap: 10px;
            justify-content: center;
            flex-wrap: wrap;
        }
        
        .replay-btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            background: linear-gradient(45deg, #667eea, #764ba2);
            color: white;
            transition: transform 0.2s ease;
        }
        
        .replay-btn:hover { transform: scale(1.05); }
        
        .replay-info {
            text-align: center;
            margin: 10px 0;
            font-size: 1.1rem;
            font-weight: bold;
            color: #1976d2;
        }
        
        .comparison-controls {
            background: #fff3e0;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #ff9800;
        }
        
        .circuit-info {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 15px 20px;
            border-radius: 10px;
            margin: 15px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }
        
        .circuit-icon { font-size: 2rem; }
        .circuit-details h4 { margin-bottom: 5px; }
        
        .turns-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin: 20px 0;
        }
        
        .turn-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            border-left: 4px solid #ff6f00;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .turn-card h4 {
            color: #ff6f00;
            margin-bottom: 15px;
        }
        
        .turn-stat {
            display: flex;
            justify-content: space-between;
            margin: 8px 0;
            padding: 5px 0;
            border-bottom: 1px solid #f0f0f0;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        
        .chart-container canvas { max-height: 400px; }
        
        .speed-marker { background: transparent !important; border: none !important; }
        .replay-marker { background: transparent !important; border: none !important; }
        
        .auto-detect-box {
            background: #e3f2fd;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
            border-left: 4px solid #1976d2;
        }
        
        @media (max-width: 768px) {
            .stats-grid { 
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }
            
            .stat-card { padding: 15px; }
            .stat-value { font-size: 1.5rem; }
            .stat-label { font-size: 0.7rem; }
            .session-header { flex-direction: column; text-align: center; }
            .session-info h2 { font-size: 1.2rem; }
            .header h1 { font-size: 1.8rem; }
            .container { padding: 15px; }
            .map-container, #map { height: 400px; min-height: 400px; }
            table { font-size: 0.75rem; }
            table th, table td { padding: 6px 4px; }
            .tab { padding: 10px 12px; font-size: 0.85rem; }
            .analysis-card { padding: 15px; }
            .analysis-card h4 { font-size: 1rem; }
            .analysis-grid { grid-template-columns: 1fr; }
            .track-stats { grid-template-columns: repeat(2, 1fr); gap: 10px; }
            .turns-grid { grid-template-columns: 1fr; }
        }

        @media (max-width: 900px) and (orientation: landscape) {
            .container { padding: 10px; }
            .stats-grid { grid-template-columns: repeat(3, 1fr); gap: 8px; }
            .stat-card { padding: 10px; }
            .stat-value { font-size: 1.3rem; }
            .stat-label { font-size: 0.65rem; }
            .map-container, #map { height: 300px; min-height: 300px; }
            .header { padding: 15px; }
            .header h1 { font-size: 1.5rem; }
            table { font-size: 0.7rem; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>GPS Race Analyzer Pro</h1>
        <p>Analyse avancee de sessions de chronometrage GPS</p>
    </div>
    
    <div class="container">
        <div class="upload-area" id="upload-area">
            <div class="upload-icon">üìÅ</div>
            <h3>Glissez-deposez votre fichier JSON</h3>
            <p>ou cliquez pour selectionner</p>
            <input type="file" id="file-input" accept=".json" style="display: none;">
        </div>

        <div id="session-content">
            <div class="session-header">
                <div class="session-info">
                    <h2 id="session-title">Session Circuit</h2>
                    <div class="session-date" id="session-date"></div>
                </div>
                <div class="session-badge" id="session-badge"></div>
            </div>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-value" id="stat-laps">-</div>
                    <div class="stat-label">Tours Termines</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-best">-</div>
                    <div class="stat-label">Meilleur Temps</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-maxspeed">-</div>
                    <div class="stat-label">Vitesse Max (km/h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-avgspeed">-</div>
                    <div class="stat-label">Vitesse Moy (km/h)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-distance">-</div>
                    <div class="stat-label">Distance (km)</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value" id="stat-total">-</div>
                    <div class="stat-label">Temps Total</div>
                </div>
            </div>
            
            <div class="tabs">
                <button class="tab active" onclick="showTab('laps')">Tours</button>
                <button class="tab" onclick="showTab('track')">Circuit</button>
                <button class="tab" onclick="showTab('analysis')">Analyse</button>
                <button class="tab" onclick="showTab('progression')">Progression</button>
                <button class="tab" onclick="showTab('turns')">Virages</button>
                <button class="tab" onclick="showTab('export')">Export</button>
            </div>
            
            <div id="laps-content" class="tab-content active">
                <table id="laps-table">
                    <thead>
                        <tr>
                            <th>Tour</th>
                            <th>Temps</th>
                            <th>Ecart</th>
                            <th>V.Max</th>
                            <th>V.Moy</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
                </table>
            </div>
            
            <div id="track-content" class="tab-content">
                <div class="comparison-controls">
                    <h4 style="margin-bottom: 10px; color: #ff6f00;">Comparaison de 2 Tours</h4>
                    <p style="margin-bottom: 15px; font-size: 0.9rem;">Comparez le meilleur tour avec un autre tour</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 15px; margin-bottom: 15px;">
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Meilleur Temps</label>
                            <select id="compare-lap1" disabled style="width: 100%; padding: 8px; border: 2px solid #4caf50; border-radius: 5px; font-size: 1rem; background: #e8f5e9;">
                                <option value="">-- Automatique --</option>
                            </select>
                        </div>
                        <div>
                            <label style="display: block; margin-bottom: 5px; font-weight: 500;">Tour compar√©</label>
                            <select id="compare-lap2" style="width: 100%; padding: 8px; border: 2px solid #1976d2; border-radius: 5px; font-size: 1rem;">
                                <option value="">-- Selectionner --</option>
                            </select>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; flex-wrap: wrap;">
                        <button class="replay-btn" onclick="compareSelectedLaps()">Comparer les Tours</button>
                        <button class="replay-btn" style="background: linear-gradient(45deg, #f44336, #e91e63);" onclick="clearComparison()">Effacer la Comparaison</button>
                    </div>
                    
                    <div id="comparison-legend" style="display: none; margin-top: 15px; padding: 10px; background: white; border-radius: 5px;">
                        <strong>Legende:</strong>
                        <div style="display: flex; gap: 15px; flex-wrap: wrap; margin-top: 5px;" id="legend-items"></div>
                    </div>
                </div>

                <div class="auto-detect-box" id="circuit-unknown" style="display: none;">
                    <h4 style="margin-bottom: 10px;">Circuit Non Identifi√©</h4>
                    <p style="margin-bottom: 15px;">Ce circuit n'est pas dans la base de donn√©es des 155 circuits fran√ßais.</p>
                    <button class="replay-btn" style="background: linear-gradient(45deg, #9c27b0, #ba68c8);" 
                            onclick="showAllCircuits()">S√©lectionner manuellement</button>
                </div>
                
                <div class="circuit-info" id="circuit-info" style="display: none;">
                    <div class="circuit-icon"></div>
                    <div class="circuit-details">
                        <h4 id="circuit-name">Circuit detecte</h4>
                        <p id="circuit-location"></p>
                    </div>
                </div>
                
                <div class="map-controls">
                    <button style="background: #2196f3; color: white;" onclick="switchMapView('satellite')">Vue Satellite</button>
                    <button style="background: #4caf50; color: white;" onclick="switchMapView('street')">Vue Route</button>
                </div>
                
                <div class="map-container">
                    <div id="map"></div>
                </div>
                
                <div class="replay-controls" id="replay-controls-circuit">
                    <div class="replay-info" id="replay-info-circuit">
                        Temps: <span id="replay-time-circuit">0.0s</span> | 
                        Vitesse: <span id="replay-speed-circuit">0 km/h</span> | 
                        Position: <span id="replay-position-circuit">0/0</span>
                    </div>
                    
                    <input type="range" class="replay-slider" id="replay-slider-circuit" min="0" max="100" value="0">
                    
                    <div class="replay-buttons">
                        <button class="replay-btn" onclick="replayControl('play')">Play</button>
                        <button class="replay-btn" onclick="replayControl('pause')">Pause</button>
                        <button class="replay-btn" onclick="replayControl('reset')">Reset</button>
                        <button class="replay-btn" onclick="changeReplaySpeed(0.5)">0.5x</button>
                        <button class="replay-btn" onclick="changeReplaySpeed(1)">1x</button>
                        <button class="replay-btn" onclick="changeReplaySpeed(2)">2x</button>
                        <button class="replay-btn" onclick="changeReplaySpeed(5)">5x</button>
                    </div>
                </div>
                
                <div class="chart-container" id="speed-chart-container">
                    <h4 style="margin-bottom: 15px; color: #1976d2;">Evolution de la Vitesse</h4>
                    <canvas id="speed-chart"></canvas>
                </div>
                
                <div class="track-stats">
                    <div class="track-stat-card">
                        <div class="track-stat-value" id="track-points">-</div>
                        <div class="track-stat-label">Points GPS</div>
                    </div>
                    <div class="track-stat-card">
                        <div class="track-stat-value" id="track-distance">-</div>
                        <div class="track-stat-label">Distance parcourue</div>
                    </div>
                    <div class="track-stat-card">
                        <div class="track-stat-value" id="track-minspeed">-</div>
                        <div class="track-stat-label">Vitesse min</div>
                    </div>
                    <div class="track-stat-card">
                        <div class="track-stat-value" id="track-maxspeed">-</div>
                        <div class="track-stat-label">Vitesse max</div>
                    </div>
                </div>
            </div>
            
            <div id="analysis-content" class="tab-content">
                <div class="analysis-grid" id="analysis-grid"></div>
            </div>
            
            <div id="progression-content" class="tab-content">
                <div class="progress-bars" id="progress-bars"></div>
            </div>
            
            <div id="turns-content" class="tab-content">
                <h3 style="margin-bottom: 20px; color: #1976d2;">Analyse Detaillee des Virages</h3>
                <div class="turns-grid" id="turns-grid"></div>
            </div>
            
            <div id="export-content" class="tab-content">
                <div class="export-section">
                    <h3 style="margin-bottom: 15px; color: #1976d2;">Exporter les Donnees</h3>
                    <p style="color: #666; margin-bottom: 20px;">Telechargez vos donnees dans differents formats</p>
                    
                    <div class="export-buttons">
                        <button class="export-btn" style="background: #4caf50;" onclick="exportData('csv')">Export CSV</button>
                        <button class="export-btn" style="background: #2196f3;" onclick="exportData('gpx')">Export GPX</button>
                        <button class="export-btn" style="background: #ff9800;" onclick="exportData('racechrono')">Format RaceChrono</button>
                        <button class="export-btn" style="background: #9c27b0;" onclick="exportData('telemetry')">Telemetrie Complete</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    
    <script>
        let sessionData = null;
        let map = null;
        let gpsLayer = null;
        let currentMapView = 'satellite';
        let replayMarker = null;
        let replayInterval = null;
        let replaySpeed = 1;
        let replayIndex = 0;
        let speedChart = null;
        let comparisonLayers = [];
        let lapSegments = [];
        let comparisonChart = null;
        let isComparisonMode = false;
        let currentReplayData = null;

        // BASE DE DONN√âES COMPL√àTE - 155 CIRCUITS FRANCE
        const CIRCUITS_DATABASE = [
            // CIRCUITS AUTOMOBILE (33)
            { name: "Circuit Carole", location: "Aulnay-sous-Bois, √éle-de-France", 
              lat: 48.9534, lng: 2.4847, radius: 2000, length: 1.814, type: "auto" },
            { name: "Autodrome de Linas-Montlh√©ry", location: "Linas, √éle-de-France", 
              lat: 48.6428, lng: 2.2669, radius: 3000, length: 2.548, type: "auto" },
            { name: "La Fert√©-Gaucher", location: "La Fert√©-Gaucher, √éle-de-France", 
              lat: 48.7808, lng: 3.3072, radius: 2000, length: 2.800, type: "auto" },
            { name: "Croix-en-Ternois", location: "Croix-en-Ternois, Hauts-de-France", 
              lat: 50.3456, lng: 2.2347, radius: 2000, length: 2.500, type: "auto" },
            { name: "Clastres", location: "Clastres, Hauts-de-France", 
              lat: 49.7414, lng: 3.2086, radius: 2000, length: 2.780, type: "auto" },
            { name: "Circuit des √âcuyers", location: "Beuvardes, Hauts-de-France", 
              lat: 49.1073, lng: 3.5069, radius: 2000, length: 2.750, type: "auto" },
            { name: "Folembray", location: "Folembray, Hauts-de-France", 
              lat: 49.6692, lng: 3.4647, radius: 1500, length: 2.080, type: "auto" },
            { name: "Magny-Cours", location: "Nevers, Bourgogne-Franche-Comt√©", 
              lat: 46.8642, lng: 3.1633, radius: 3000, length: 4.411, type: "auto" },
            { name: "Dijon-Prenois", location: "Prenois, Bourgogne-Franche-Comt√©", 
              lat: 47.3628, lng: 4.8997, radius: 2500, length: 3.801, type: "auto" },
            { name: "Mornay", location: "Mornay, Bourgogne-Franche-Comt√©", 
              lat: 46.3753, lng: 4.6253, radius: 1500, length: 2.100, type: "auto" },
            { name: "Bresse", location: "Saint-Marcel, Bourgogne-Franche-Comt√©", 
              lat: 46.5261, lng: 5.3603, radius: 2000, length: 3.100, type: "auto" },
            { name: "Paul Ricard", location: "Le Castellet, PACA", 
              lat: 43.2506, lng: 5.7919, radius: 3000, length: 5.842, type: "auto" },
            { name: "Circuit du Var", location: "Le Luc, PACA", 
              lat: 43.3847, lng: 6.3881, radius: 2000, length: 3.800, type: "auto" },
            { name: "Circuit de L√©denon", location: "L√©denon, Occitanie", 
              lat: 43.9211, lng: 4.5025, radius: 2000, length: 3.156, type: "auto" },
            { name: "Al√®s C√©vennes", location: "Al√®s, Occitanie", 
              lat: 44.0678, lng: 4.0839, radius: 2000, length: 2.485, type: "auto" },
            { name: "Nogaro", location: "Nogaro, Occitanie", 
              lat: 43.7611, lng: -0.0314, radius: 2500, length: 3.636, type: "auto" },
            { name: "Albi", location: "Albi, Occitanie", 
              lat: 43.9147, lng: 2.1153, radius: 2000, length: 3.565, type: "auto" },
            { name: "Toulouse Francazal", location: "Toulouse, Occitanie", 
              lat: 43.5456, lng: 1.3678, radius: 1500, length: 2.680, type: "auto" },
            { name: "Pau-Arnos", location: "Arnos, Nouvelle-Aquitaine", 
              lat: 43.4556, lng: -0.4489, radius: 2500, length: 3.030, type: "auto" },
            { name: "Bordeaux-M√©rignac", location: "M√©rignac, Nouvelle-Aquitaine", 
              lat: 44.8311, lng: -0.6889, radius: 2000, length: 2.529, type: "auto" },
            { name: "Val de Vienne", location: "Le Vigeant, Nouvelle-Aquitaine", 
              lat: 46.5733, lng: 0.6578, radius: 2500, length: 3.775, type: "auto" },
            { name: "Faleyras", location: "Faleyras, Nouvelle-Aquitaine", 
              lat: 44.7461, lng: -0.2578, radius: 1500, length: 1.900, type: "auto" },
            { name: "Lurcy-L√©vis", location: "Lurcy-L√©vis, Auvergne-Rh√¥ne-Alpes", 
              lat: 46.7386, lng: 2.9286, radius: 2500, length: 3.750, type: "auto" },
            { name: "Issoire", location: "Issoire, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.5439, lng: 3.2769, radius: 2000, length: 3.100, type: "auto" },
            { name: "Anneau du Rhin", location: "Biltzheim, Grand Est", 
              lat: 47.9536, lng: 7.3597, radius: 2500, length: 3.705, type: "auto" },
            { name: "Chambley", location: "Chambley, Grand Est", 
              lat: 49.0225, lng: 5.8803, radius: 2500, length: 3.750, type: "auto" },
            { name: "Bugatti Le Mans", location: "Le Mans, Pays de la Loire", 
              lat: 47.9561, lng: 0.2269, radius: 3000, length: 4.185, type: "auto" },
            { name: "Ch√¢teauroux", location: "Ch√¢teauroux, Centre-Val de Loire", 
              lat: 46.8597, lng: 1.7253, radius: 2500, length: 3.650, type: "auto" },
            { name: "Dreux", location: "Dreux, Centre-Val de Loire", 
              lat: 48.7531, lng: 1.3547, radius: 1500, length: 2.200, type: "auto" },
            { name: "Abbeville", location: "Abbeville, Hauts-de-France", 
              lat: 50.0981, lng: 1.8392, radius: 1500, length: 1.720, type: "auto" },
            { name: "Mettet", location: "Mettet, Belgique (proche France)", 
              lat: 50.3206, lng: 4.6617, radius: 2500, length: 2.650, type: "auto" },
            { name: "Spa-Francorchamps", location: "Stavelot, Belgique (proche France)", 
              lat: 50.4372, lng: 5.9714, radius: 4000, length: 7.004, type: "auto" },
            
            // CIRCUITS KARTING (94)
            { name: "SODI Paris", location: "Rungis, √éle-de-France", 
              lat: 48.7508, lng: 2.3528, radius: 1000, length: 1.150, type: "karting" },
            { name: "PK1 Br√©tigny", location: "Br√©tigny-sur-Orge, √éle-de-France", 
              lat: 48.6042, lng: 2.3061, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting de S√©nart", location: "Lieusaint, √éle-de-France", 
              lat: 48.6267, lng: 2.5492, radius: 1000, length: 1.200, type: "karting" },
            { name: "Kart Ouest", location: "Trappes, √éle-de-France", 
              lat: 48.7686, lng: 1.9958, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Cormeilles", location: "Cormeilles-en-Parisis, √éle-de-France", 
              lat: 48.9753, lng: 2.1997, radius: 800, length: 1.080, type: "karting" },
            { name: "Racing Kart Dupr√©", location: "√âvry, √éle-de-France", 
              lat: 48.6272, lng: 2.4492, radius: 800, length: 0.960, type: "karting" },
            { name: "Karting des Fagnes", location: "Mariembourg, √éle-de-France proche", 
              lat: 50.0894, lng: 4.5208, radius: 1000, length: 1.250, type: "karting" },
            { name: "Racing Kart de Mantes", location: "Mantes-la-Jolie, √éle-de-France", 
              lat: 48.9867, lng: 1.7122, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting de Lyon", location: "Corbas, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.6686, lng: 4.9022, radius: 1000, length: 1.200, type: "karting" },
            { name: "Outdoor Lyon Ouest", location: "L'Arbresle, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.8353, lng: 4.6197, radius: 800, length: 1.050, type: "karting" },
            { name: "Racing Kart Corsa", location: "Chaponnay, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.6231, lng: 4.9347, radius: 1000, length: 1.350, type: "karting" },
            { name: "Karting de Grenoble", location: "Saint-Quentin-sur-Is√®re, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.2564, lng: 5.5539, radius: 1000, length: 1.280, type: "karting" },
            { name: "Karting Annecy", location: "Argonay, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.9344, lng: 6.1478, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Saint-√âtienne", location: "Andr√©zieux-Bouth√©on, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.5283, lng: 4.2636, radius: 800, length: 1.050, type: "karting" },
            { name: "Kart 01", location: "Bourg-en-Bresse, Auvergne-Rh√¥ne-Alpes", 
              lat: 46.2058, lng: 5.2272, radius: 800, length: 1.000, type: "karting" },
            { name: "Karting Chamb√©ry", location: "La Ravoire, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.5631, lng: 5.9656, radius: 800, length: 1.120, type: "karting" },
            { name: "Piste Kart 07", location: "Privas, Auvergne-Rh√¥ne-Alpes", 
              lat: 44.7356, lng: 4.5986, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Valence", location: "Alixan, Auvergne-Rh√¥ne-Alpes", 
              lat: 44.9769, lng: 5.0308, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Vichy", location: "Hauterive, Auvergne-Rh√¥ne-Alpes", 
              lat: 46.1092, lng: 3.4297, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Roanne", location: "Le Coteau, Auvergne-Rh√¥ne-Alpes", 
              lat: 46.0300, lng: 4.0886, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting de Lons", location: "Lons, Nouvelle-Aquitaine", 
              lat: 43.3167, lng: -0.4000, radius: 800, length: 1.100, type: "karting" },
            { name: "Speed Park Bordeaux", location: "M√©rignac, Nouvelle-Aquitaine", 
              lat: 44.8497, lng: -0.6944, radius: 1000, length: 1.300, type: "karting" },
            { name: "Karting Saint-Junien", location: "Saint-Junien, Nouvelle-Aquitaine", 
              lat: 45.8881, lng: 0.8997, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Poitiers", location: "Chasseneuil-du-Poitou, Nouvelle-Aquitaine", 
              lat: 46.6536, lng: 0.3731, radius: 800, length: 1.080, type: "karting" },
            { name: "Karting La Rochelle", location: "Puilboreau, Nouvelle-Aquitaine", 
              lat: 46.1811, lng: -1.1136, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Bergerac", location: "Bergerac, Nouvelle-Aquitaine", 
              lat: 44.8528, lng: 0.4833, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Angoul√™me", location: "L'Isle-d'Espagnac, Nouvelle-Aquitaine", 
              lat: 45.6553, lng: 0.1522, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Pau", location: "Lescar, Nouvelle-Aquitaine", 
              lat: 43.3381, lng: -0.4253, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Bayonne", location: "Ondres, Nouvelle-Aquitaine", 
              lat: 43.5597, lng: -1.4564, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Limoges", location: "Bonnac-la-C√¥te, Nouvelle-Aquitaine", 
              lat: 45.8881, lng: 1.2333, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Brive", location: "Brive-la-Gaillarde, Nouvelle-Aquitaine", 
              lat: 45.1508, lng: 1.5331, radius: 700, length: 0.920, type: "karting" },
            { name: "Circuit de Karting du Val d'Argenton", location: "Argentonnay, Nouvelle-Aquitaine", 
              lat: 46.9886, lng: -0.4292, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Toulouse", location: "Aussonne, Occitanie", 
              lat: 43.6814, lng: 1.3192, radius: 1000, length: 1.250, type: "karting" },
            { name: "Karting Montpellier", location: "Vendargues, Occitanie", 
              lat: 43.6553, lng: 3.9672, radius: 800, length: 1.150, type: "karting" },
            { name: "Karting Perpignan", location: "Al√©nya, Occitanie", 
              lat: 42.6453, lng: 2.9889, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Narbonne", location: "Narbonne, Occitanie", 
              lat: 43.1839, lng: 3.0036, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting N√Æmes", location: "Marguerittes, Occitanie", 
              lat: 43.8628, lng: 4.4439, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Carcassonne", location: "Carcassonne, Occitanie", 
              lat: 43.2131, lng: 2.3486, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Tarbes", location: "S√©m√©ac, Occitanie", 
              lat: 43.2281, lng: 0.1114, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Rodez", location: "Onet-le-Ch√¢teau, Occitanie", 
              lat: 44.3694, lng: 2.5764, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting B√©ziers", location: "Villeneuve-l√®s-B√©ziers, Occitanie", 
              lat: 43.3275, lng: 3.2653, radius: 700, length: 1.050, type: "karting" },
            { name: "Karting Cahors", location: "Cahors, Occitanie", 
              lat: 44.4478, lng: 1.4403, radius: 700, length: 0.920, type: "karting" },
            { name: "RKC Le Mans", location: "Le Mans, Pays de la Loire", 
              lat: 47.9561, lng: 0.2269, radius: 1000, length: 1.382, type: "karting" },
            { name: "Karting Nantes", location: "Bouguenais, Pays de la Loire", 
              lat: 47.1778, lng: -1.6181, radius: 1000, length: 1.200, type: "karting" },
            { name: "Karting Angers", location: "√âcouflant, Pays de la Loire", 
              lat: 47.5308, lng: -0.5297, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting La Roche-sur-Yon", location: "Mouilleron-le-Captif, Pays de la Loire", 
              lat: 46.7211, lng: -1.4444, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Laval", location: "Chang√©, Pays de la Loire", 
              lat: 48.0939, lng: -0.7925, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Saint-Nazaire", location: "Trignac, Pays de la Loire", 
              lat: 47.3231, lng: -2.1953, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Cholet", location: "Cholet, Pays de la Loire", 
              lat: 47.0586, lng: -0.8753, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Sabl√©", location: "Sabl√©-sur-Sarthe, Pays de la Loire", 
              lat: 47.8436, lng: -0.3311, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting Marseille", location: "Plan-de-Campagne, PACA", 
              lat: 43.4897, lng: 5.4331, radius: 1000, length: 1.250, type: "karting" },
            { name: "Karting Nice", location: "Carros, PACA", 
              lat: 43.7839, lng: 7.1864, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Toulon", location: "La Valette-du-Var, PACA", 
              lat: 43.1372, lng: 5.9842, radius: 800, length: 1.080, type: "karting" },
            { name: "Karting Avignon", location: "Sorgues, PACA", 
              lat: 44.0094, lng: 4.8728, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Gap", location: "Gap, PACA", 
              lat: 44.5592, lng: 6.0794, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Aix-en-Provence", location: "Venelles, PACA", 
              lat: 43.5950, lng: 5.4814, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Antibes", location: "Biot, PACA", 
              lat: 43.6286, lng: 7.0972, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Cannes", location: "Le Cannet, PACA", 
              lat: 43.5778, lng: 7.0186, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Fr√©jus", location: "Fr√©jus, PACA", 
              lat: 43.4331, lng: 6.7372, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting Strasbourg", location: "Ostwald, Grand Est", 
              lat: 48.5431, lng: 7.7139, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Mulhouse", location: "Sausheim, Grand Est", 
              lat: 47.7881, lng: 7.3764, radius: 800, length: 1.080, type: "karting" },
            { name: "Karting Reims", location: "Cormontreuil, Grand Est", 
              lat: 49.2181, lng: 4.0494, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Metz", location: "Augny, Grand Est", 
              lat: 49.0672, lng: 6.1208, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Nancy", location: "Tomblaine, Grand Est", 
              lat: 48.6831, lng: 6.2200, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Colmar", location: "Wintzenheim, Grand Est", 
              lat: 48.0722, lng: 7.2825, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting √âpinal", location: "√âpinal, Grand Est", 
              lat: 48.1744, lng: 6.4500, radius: 700, length: 0.920, type: "karting" },
            { name: "Karting Lille", location: "Lezennes, Hauts-de-France", 
              lat: 50.6150, lng: 3.1150, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Amiens", location: "Rivery, Hauts-de-France", 
              lat: 49.9092, lng: 2.3231, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Valenciennes", location: "Rouvignies, Hauts-de-France", 
              lat: 50.3261, lng: 3.5403, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Dunkerque", location: "Grande-Synthe, Hauts-de-France", 
              lat: 51.0136, lng: 2.3019, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Calais", location: "Marck, Hauts-de-France", 
              lat: 50.9453, lng: 1.9556, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Arras", location: "Saint-Laurent-Blangy, Hauts-de-France", 
              lat: 50.3067, lng: 2.8089, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting Beauvais", location: "Till√©, Hauts-de-France", 
              lat: 49.4614, lng: 2.1128, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Douai", location: "Lambres-lez-Douai, Hauts-de-France", 
              lat: 50.3542, lng: 3.0592, radius: 700, length: 0.920, type: "karting" },
            { name: "Karting Rennes", location: "Chartres-de-Bretagne, Bretagne", 
              lat: 48.0439, lng: -1.7078, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Brest", location: "Gouesnou, Bretagne", 
              lat: 48.4506, lng: -4.4689, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Lorient", location: "Caudan, Bretagne", 
              lat: 47.8103, lng: -3.3364, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Vannes", location: "Ploeren, Bretagne", 
              lat: 47.6564, lng: -2.8636, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Saint-Brieuc", location: "Pl√©rin, Bretagne", 
              lat: 48.5422, lng: -2.7278, radius: 700, length: 1.020, type: "karting" },
            { name: "Karting Quimper", location: "Pluguffan, Bretagne", 
              lat: 47.9767, lng: -4.1678, radius: 700, length: 0.920, type: "karting" },
            { name: "Circuit Nelly Delamarche", location: "Foug√®res, Bretagne", 
              lat: 48.3528, lng: -1.2006, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Rouen", location: "Eslettes, Normandie", 
              lat: 49.5683, lng: 1.3597, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Caen", location: "Carpiquet, Normandie", 
              lat: 49.1883, lng: -0.4531, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Le Havre", location: "Gonfreville-l'Orcher, Normandie", 
              lat: 49.5069, lng: 0.2278, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Alen√ßon", location: "Valframbert, Normandie", 
              lat: 48.4578, lng: 0.1036, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Cherbourg", location: "La Glacerie, Normandie", 
              lat: 49.6158, lng: -1.6092, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting √âvreux", location: "Guichainville, Normandie", 
              lat: 49.0314, lng: 1.1850, radius: 700, length: 0.920, type: "karting" },
            { name: "Circuit Lucien Lebret", location: "Courseulles-sur-Mer, Normandie", 
              lat: 49.3275, lng: -0.4578, radius: 800, length: 1.080, type: "karting" },
            { name: "Circuit de Cabourg", location: "Cabourg, Normandie", 
              lat: 49.2867, lng: -0.1178, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Orl√©ans", location: "Saint-Jean-de-Braye, Centre-Val de Loire", 
              lat: 47.9117, lng: 1.9731, radius: 800, length: 1.100, type: "karting" },
            { name: "Karting Tours", location: "Chambray-l√®s-Tours, Centre-Val de Loire", 
              lat: 47.3364, lng: 0.7178, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Bourges", location: "Saint-Doulchard, Centre-Val de Loire", 
              lat: 47.1006, lng: 2.3742, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Blois", location: "Vineuil, Centre-Val de Loire", 
              lat: 47.5831, lng: 1.3778, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Chartres", location: "Luc√©, Centre-Val de Loire", 
              lat: 48.4344, lng: 1.4656, radius: 700, length: 0.920, type: "karting" },
            { name: "Karting Dijon", location: "Chen√¥ve, Bourgogne-Franche-Comt√©", 
              lat: 47.2919, lng: 5.0047, radius: 800, length: 1.050, type: "karting" },
            { name: "Karting Besan√ßon", location: "Pirey, Bourgogne-Franche-Comt√©", 
              lat: 47.2622, lng: 5.9725, radius: 700, length: 1.000, type: "karting" },
            { name: "Karting Auxerre", location: "Mon√©teau, Bourgogne-Franche-Comt√©", 
              lat: 47.8289, lng: 3.5703, radius: 700, length: 0.950, type: "karting" },
            { name: "Karting Belfort", location: "Andelnans, Bourgogne-Franche-Comt√©", 
              lat: 47.6092, lng: 6.8764, radius: 700, length: 0.980, type: "karting" },
            { name: "Karting Ajaccio", location: "Afa, Corse", 
              lat: 41.9561, lng: 8.8025, radius: 700, length: 0.900, type: "karting" },
            { name: "Karting Bastia", location: "Borgo, Corse", 
              lat: 42.5614, lng: 9.4264, radius: 700, length: 0.950, type: "karting" },
            
            // CIRCUITS MOTO (28)
            { name: "Carole Moto", location: "Aulnay-sous-Bois, √éle-de-France", 
              lat: 48.9534, lng: 2.4847, radius: 2000, length: 1.814, type: "moto" },
            { name: "Magny-Cours Moto", location: "Nevers, Bourgogne-Franche-Comt√©", 
              lat: 46.8642, lng: 3.1633, radius: 3000, length: 4.411, type: "moto" },
            { name: "Paul Ricard Moto", location: "Le Castellet, PACA", 
              lat: 43.2506, lng: 5.7919, radius: 3000, length: 5.842, type: "moto" },
            { name: "Dijon-Prenois Moto", location: "Prenois, Bourgogne-Franche-Comt√©", 
              lat: 47.3628, lng: 4.8997, radius: 2500, length: 3.801, type: "moto" },
            { name: "L√©denon Moto", location: "L√©denon, Occitanie", 
              lat: 43.9211, lng: 4.5025, radius: 2000, length: 3.156, type: "moto" },
            { name: "Al√®s C√©vennes Moto", location: "Al√®s, Occitanie", 
              lat: 44.0678, lng: 4.0839, radius: 2000, length: 2.485, type: "moto" },
            { name: "Pau-Arnos Moto", location: "Arnos, Nouvelle-Aquitaine", 
              lat: 43.4556, lng: -0.4489, radius: 2500, length: 3.030, type: "moto" },
            { name: "Nogaro Moto", location: "Nogaro, Occitanie", 
              lat: 43.7611, lng: -0.0314, radius: 2500, length: 3.636, type: "moto" },
            { name: "Le Mans Moto", location: "Le Mans, Pays de la Loire", 
              lat: 47.9561, lng: 0.2269, radius: 3000, length: 4.185, type: "moto" },
            { name: "Lurcy-L√©vis Moto", location: "Lurcy-L√©vis, Auvergne-Rh√¥ne-Alpes", 
              lat: 46.7386, lng: 2.9286, radius: 2500, length: 3.750, type: "moto" },
            { name: "Issoire Moto", location: "Issoire, Auvergne-Rh√¥ne-Alpes", 
              lat: 45.5439, lng: 3.2769, radius: 2000, length: 3.100, type: "moto" },
            { name: "Anneau du Rhin Moto", location: "Biltzheim, Grand Est", 
              lat: 47.9536, lng: 7.3597, radius: 2500, length: 3.705, type: "moto" },
            { name: "Croix-en-Ternois Moto", location: "Croix-en-Ternois, Hauts-de-France", 
              lat: 50.3456, lng: 2.2347, radius: 2000, length: 2.500, type: "moto" },
            { name: "Clastres Moto", location: "Clastres, Hauts-de-France", 
              lat: 49.7414, lng: 3.2086, radius: 2000, length: 2.780, type: "moto" },
            { name: "Folembray Moto", location: "Folembray, Hauts-de-France", 
              lat: 49.6692, lng: 3.4647, radius: 1500, length: 2.080, type: "moto" },
            { name: "Val de Vienne Moto", location: "Le Vigeant, Nouvelle-Aquitaine", 
              lat: 46.5733, lng: 0.6578, radius: 2500, length: 3.775, type: "moto" },
            { name: "Bordeaux-M√©rignac Moto", location: "M√©rignac, Nouvelle-Aquitaine", 
              lat: 44.8311, lng: -0.6889, radius: 2000, length: 2.529, type: "moto" },
            { name: "Albi Moto", location: "Albi, Occitanie", 
              lat: 43.9147, lng: 2.1153, radius: 2000, length: 3.565, type: "moto" },
            { name: "La Fert√©-Gaucher Moto", location: "La Fert√©-Gaucher, √éle-de-France", 
              lat: 48.7808, lng: 3.3072, radius: 2000, length: 2.800, type: "moto" },
            { name: "Bresse Moto", location: "Saint-Marcel, Bourgogne-Franche-Comt√©", 
              lat: 46.5261, lng: 5.3603, radius: 2000, length: 3.100, type: "moto" },
            { name: "Circuit du Var Moto", location: "Le Luc, PACA", 
              lat: 43.3847, lng: 6.3881, radius: 2000, length: 3.800, type: "moto" },
            { name: "Chambley Moto", location: "Chambley, Grand Est", 
              lat: 49.0225, lng: 5.8803, radius: 2500, length: 3.750, type: "moto" },
            { name: "Abbeville Moto", location: "Abbeville, Hauts-de-France", 
              lat: 50.0981, lng: 1.8392, radius: 1500, length: 1.720, type: "moto" },
            { name: "Dreux Moto", location: "Dreux, Centre-Val de Loire", 
              lat: 48.7531, lng: 1.3547, radius: 1500, length: 2.200, type: "moto" },
            { name: "Montlh√©ry Moto", location: "Linas, √éle-de-France", 
              lat: 48.6428, lng: 2.2669, radius: 3000, length: 2.548, type: "moto" },
            { name: "Ch√¢teauroux Moto", location: "Ch√¢teauroux, Centre-Val de Loire", 
              lat: 46.8597, lng: 1.7253, radius: 2500, length: 3.650, type: "moto" },
            { name: "Faleyras Moto", location: "Faleyras, Nouvelle-Aquitaine", 
              lat: 44.7461, lng: -0.2578, radius: 1500, length: 1.900, type: "moto" },
            { name: "Mettet Moto", location: "Mettet, Belgique (proche France)", 
              lat: 50.3206, lng: 4.6617, radius: 2500, length: 2.650, type: "moto" }
        ];

        let detectedCircuit = null;

        // INITIALISATION
        const uploadArea = document.getElementById('upload-area');
        const fileInput = document.getElementById('file-input');
        
        uploadArea.addEventListener('click', () => fileInput.click());
        uploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadArea.classList.add('drag-over');
        });
        uploadArea.addEventListener('dragleave', () => uploadArea.classList.remove('drag-over'));
        uploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadArea.classList.remove('drag-over');
            const file = e.dataTransfer.files[0];
            if (file && file.type === 'application/json') loadSession(file);
        });
        
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) loadSession(file);
        });
       
        function loadSession(file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    sessionData = JSON.parse(e.target.result);
                    displaySession();
                } catch (error) {
                    alert('Erreur de lecture du fichier JSON: ' + error.message);
                }
            };
            reader.readAsText(file);
        }
        
        function displaySession() {
            document.getElementById('upload-area').style.display = 'none';
            document.getElementById('session-content').style.display = 'block';
            
            document.getElementById('session-title').textContent = 'Session Circuit - Analyse GPS';
            
            let dateText = "Date inconnue";
            
            if (sessionData.id) {
                const parts = sessionData.id.split('-');
                if (parts.length === 2) {
                    const dateStr = parts[0];
                    const timeStr = parts[1];
                    
                    const day = dateStr.substring(0, 2);
                    const month = dateStr.substring(2, 4);
                    const year = dateStr.substring(4, 8);
                    const hour = timeStr.substring(0, 2);
                    const minute = timeStr.substring(2, 4);
                    
                    dateText = `${day}/${month}/${year} √† ${hour}:${minute}`;
                } else {
                    dateText = sessionData.id;
                }
            }
            
            document.getElementById('session-date').textContent = dateText;
            
            const trackLength = sessionData.trackLength || 1.814;
            document.getElementById('session-badge').textContent = `${trackLength} km - ${sessionData.laps} tours`;
            
            document.getElementById('stat-laps').textContent = sessionData.laps;
            document.getElementById('stat-best').textContent = formatTime(sessionData.best);
            document.getElementById('stat-maxspeed').textContent = sessionData.maxSpd.toFixed(1);
            
            const avgSpeed = calculateAverageSpeed();
            document.getElementById('stat-avgspeed').textContent = avgSpeed.toFixed(1);
            document.getElementById('stat-distance').textContent = trackLength.toFixed(3);
            
            const totalTime = sessionData.times.reduce((a, b) => a + b, 0);
            document.getElementById('stat-total').textContent = formatTime(totalTime);
            
            displayLapsTable();
            displayAnalysis();
            displayProgression();
            segmentLapsFromGPSTrack();
        }

        function detectCircuitFromGPS() {
            if (!sessionData || !sessionData.gpsTrack || sessionData.gpsTrack.length === 0) {
                return null;
            }
            
            const track = sessionData.gpsTrack;
            const centerLat = track.reduce((sum, p) => sum + p.lat, 0) / track.length;
            const centerLng = track.reduce((sum, p) => sum + p.lng, 0) / track.length;
            
            for (const circuit of CIRCUITS_DATABASE) {
                const distance = calculateDistance(
                    { lat: centerLat, lng: centerLng },
                    { lat: circuit.lat, lng: circuit.lng }
                );
                
                if (distance < circuit.radius) {
                    return circuit;
                }
            }
            
            return null;
        }

        function showCircuitDetection() {
            detectedCircuit = detectCircuitFromGPS();
            
            const circuitInfo = document.getElementById('circuit-info');
            const circuitUnknown = document.getElementById('circuit-unknown');
            
            if (detectedCircuit) {
                circuitInfo.style.display = 'flex';
                circuitUnknown.style.display = 'none';
                
                document.querySelector('#circuit-info .circuit-icon').textContent = 
                    detectedCircuit.type === 'auto' ? 'üèéÔ∏è' : 'üèÅ';
                document.getElementById('circuit-name').textContent = detectedCircuit.name;
                document.getElementById('circuit-location').textContent = 
                    `${detectedCircuit.location} - ${detectedCircuit.length} km`;
            } else {
                circuitInfo.style.display = 'none';
                circuitUnknown.style.display = 'block'; 
            }
        }

        function showAllCircuits() {
            const modal = document.createElement('div');
            modal.id = 'circuits-modal';
            modal.style.cssText = `
                position: fixed; top: 0; left: 0; width: 100%; height: 100%;
                background: rgba(0,0,0,0.8); z-index: 10000;
                display: flex; align-items: center; justify-content: center;
                padding: 20px; overflow-y: auto;
            `;
            
            let html = `
                <div style="background: white; border-radius: 15px; padding: 30px; max-width: 600px; 
                            width: 100%; max-height: 80vh; overflow-y: auto;">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h3 style="margin: 0; color: #1976d2;">üèÅ S√©lection du Circuit (${CIRCUITS_DATABASE.length} circuits)</h3>
                        <button onclick="document.getElementById('circuits-modal').remove()" 
                                style="background: #f44336; color: white; border: none; padding: 8px 15px; 
                                       border-radius: 5px; cursor: pointer;">‚úï</button>
                    </div>
                    <p style="color: #666; margin-bottom: 20px;">Circuit non d√©tect√© automatiquement. Veuillez s√©lectionner :</p>
            `;
            
            html += `<h3 style="color: #1976d2; border-bottom: 2px solid #1976d2; padding-bottom: 5px; margin: 20px 0 15px 0;">
                     üèéÔ∏è Circuits Automobile (${CIRCUITS_DATABASE.filter(c => c.type === 'auto').length})</h3>`;
            
            CIRCUITS_DATABASE.filter(c => c.type === 'auto').forEach(circuit => {
                html += `
                    <div onclick="selectCircuitManually('${circuit.name}')" 
                         style="background: white; border: 1px solid #ddd; border-radius: 8px; padding: 12px; 
                                margin-bottom: 5px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#e3f2fd'; this.style.borderColor='#1976d2'"
                         onmouseout="this.style.background='white'; this.style.borderColor='#ddd'">
                        <strong>${circuit.name}</strong><br>
                        <small style="color: #666;">${circuit.location} - ${circuit.length} km</small>
                    </div>
                `;
            });
            
            html += `<h3 style="color: #ff9800; border-bottom: 2px solid #ff9800; padding-bottom: 5px; margin: 25px 0 15px 0;">
                     üèÅ Circuits Karting (${CIRCUITS_DATABASE.filter(c => c.type === 'karting').length})</h3>`;
            
            CIRCUITS_DATABASE.filter(c => c.type === 'karting').slice(0, 20).forEach(circuit => {
                html += `
                    <div onclick="selectCircuitManually('${circuit.name}')" 
                         style="background: #fff8e1; border: 1px solid #ff9800; border-radius: 8px; padding: 12px; 
                                margin-bottom: 5px; cursor: pointer; transition: all 0.2s;"
                         onmouseover="this.style.background='#ffe0b2'"
                         onmouseout="this.style.background='#fff8e1'">
                        <strong>${circuit.name}</strong><br>
                        <small style="color: #666;">${circuit.location} - ${circuit.length} km</small>
                    </div>
                `;
            });
            
            html += '<p style="text-align: center; color: #999; margin-top: 15px; font-size: 0.9rem;">+ ' + (CIRCUITS_DATABASE.filter(c => c.type === 'karting').length - 20) + ' autres circuits karting disponibles</p>';
            
            html += '</div>';
            modal.innerHTML = html;
            document.body.appendChild(modal);
        }

        function selectCircuitManually(circuitName) {
            detectedCircuit = CIRCUITS_DATABASE.find(c => c.name === circuitName);
            document.getElementById('circuits-modal').remove();
            showCircuitDetection();
        }
        
        // SUITE DU CODE JAVASCRIPT DANS LE PROCHAIN MESSAGE (limites de taille)
    </script>
</body>
</html>